---
- hosts: localhost
  connection: local
  vars:
    packages:
      - lightdm
      - xfce4
      - xfce4-goodies
      - xfce4-power-manager
      - eog
      - xscreensaver
      - xss-lock
      - awesome
      - awesome-extra
      - dzen2
      - rofi
      - surfraw
      - xfonts-terminus
      - ttf-mscorefonts-installer
      - network-manager
      - network-manager-gnome
      - network-manager-pptp
      - network-manager-pptp-gnome
      - network-manager-openvpn
      - network-manager-openvpn-gnome
      - rxvt-unicode-256color
      - gnome-keyring
      - seahorse
      - libsecret-tools
      - keepassx
      - pass
      - pavucontrol
      - goldendict
      - zsh
      - vim-nox
      - vim-gtk
      - screen
      - tmux
      - links
      - psmisc
      - dnsutils
      - less
      - lsof
      - mc
      - time
      - p7zip-full
      - zip
      - unzip
      - git
      - git-svn
      - git-annex
      - etckeeper
      - evince
      - zathura
      - subversion
      - tig
      - rsync
      - apg
      - bar
      - pv
      - grc
      - ntp
      - pm-utils
      - num-utils
      - htop
      - iotop
      - gnuplot
      - graphviz
      - qalc
      - tree
      - ncdu
      - lftp
      - xtightvncviewer
      - freerdp-x11
      - vlc
      - qnapi
      - unrar
      - tidy
      - sudo
      - telnet
      - imagemagick
      - rlwrap
      - virtualbox
      - virtualbox-dkms
      - virtualbox-qt
      - httpie
      - curl
      - disper
      - arandr
      - suckless-tools
      - moreutils
      - python-keyring
      - strace
      - ltrace
      - stow
      - silversearcher-ag
      # networking tools
      - iftop
      - mtr
      - hping3
      - tcpdump
      - socat
      - netcat-traditional
      - ipcalc
      - sipcalc
      - wireshark
      - openvpn
      - nmap
      - rtorrent
      # webbrowsers
      - firefox
      - chromium
      - flashplugin-nonfree
      # editing
      - texlive
      - texlive-bibtex-extra
      #- texlive-fonts-extra
      - texlive-lang-polish
      - texlive-latex-extra
      - aspell-en
      - aspell-pl
      - myspell-pl
      - wpolish
      - pandoc
      - asciidoctor
      - libreoffice
      - pdftk
      - rubber
      # GPG
      - gnupg
      - signing-party # for caff
      # messaging & e-mail
      - mcabber
      - irssi
      - mutt
      - khard
      - khal
      - urlview
      - notmuch
      - notmuch-mutt
      - offlineimap
      - msmtp
      - msmtp-mta
      # firewall
      - ferm
      # development tools
      - autoconf
      - automake
      - build-essential
      - flex
      - bison
      - linux-headers-amd64
      - ipython
      - java-package
      - nodejs
      - openjdk-8-jdk
      - python
      - python-dev
      - python-pip
      - python-sphinx
      - python3
      - python3-dev
      - ruby
      - ruby-dev
      - virtualenv
      - virtualenvwrapper
      - debhelper
      - devscripts
      - dh-make
      - pbuilder
      - quilt
      - git-buildpackage
      - cowbuilder
      - cmake
      - jq
      - shellcheck
      - meld
      - xmlstarlet
      - manpages-dev
      - exuberant-ctags
      - cscope
      # Yubikey
      - yubikey-personalization
      - yubikey-personalization-gui
      # wine
      - wine
      - winetricks
    alternatives:
      - { name: x-terminal-emulator, path: /usr/bin/urxvt }
      - { name: x-www-browser, path: /usr/bin/firefox }
      - { name: editor, path: /usr/bin/vim.nox }
    default_applications:
      - { mimetype: x-scheme-handler/http, application: firefox.desktop }
      - { mimetype: x-scheme-handler/https, application: firefox.desktop }
    ferm_configuration: |
      domain (ip ip6) {
          table filter {
              chain INPUT {
                  policy DROP;
                  # connection tracking
                  mod state state INVALID DROP;
                  mod state state (ESTABLISHED RELATED) ACCEPT;
                  # allow local packet
                  interface lo ACCEPT;
                  # respond to ping
                  proto icmp ACCEPT;
              }
              chain OUTPUT {
                  policy ACCEPT;
                  # connection tracking
                  mod state state INVALID DROP;
                  mod state state (ESTABLISHED RELATED) ACCEPT;
              }
              chain FORWARD {
                  policy DROP;
                  # connection tracking
                  mod state state INVALID DROP;
                  mod state state (ESTABLISHED RELATED) ACCEPT;
              }
          }
      }
    apt_conf: |
      APT::Install-Recommends "0";
      APT::Install-Suggests "0";

  handlers:
    - name: restart ferm
      service:
        name: ferm
        state: restarted

  tasks:
    - name: configure apt
      copy:
        dest: /etc/apt/apt.conf.d/02norecommends
        content: "{{ apt_conf }}"

    - name: update apt cache
      apt:
        update_cache: yes
      changed_when: false

    - name: install packages
      apt:
        name: "{{ item }}"
        state: installed
      with_items: "{{ packages }}"

    - name: update alternatives
      alternatives:
        name: "{{ item.name }}"
        path: "{{ item.path }}"
      with_items: "{{ alternatives }}"

    - name: get a list default applications
      command: >
        /usr/bin/xdg-mime query default {{ item.mimetype }}
      with_items: "{{ default_applications }}"
      register: default_applications__list
      changed_when: false
      become_user: "{{ lookup('env', 'USER') }}"

    - name: set default applications
      command: >
        /usr/bin/xdg-mime default {{ item.0.application }} {{ item.0.mimetype }}
      with_together: 
        - "{{ default_applications }}"
        - "{{ default_applications__list.results }}" 
      when: "item.0.application != item.1.stdout"
      become_user: "{{ lookup('env', 'USER') }}"

    - name: configure ferm
      copy:
        dest: /etc/ferm/ferm.conf
        content: "{{ ferm_configuration }}"
      notify: restart ferm

# vim: ts=2 sw=2 et
